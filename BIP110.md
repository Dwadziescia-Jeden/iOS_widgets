# BIP-110 Signaling Widget

Displays BIP-110 soft fork activation status including miner signaling percentage and network node readiness.

<img src="./images/bip110.jpg" style="zoom: 67%;" />

## Features
- Current period miner signaling percentage (color-coded)
- Period progress (blocks mined / 2016)
- Network node readiness percentage
- BIP-110 ready node count
- Trend arrow when signaling changes
- Offline cache support
- Tap to open website
- Auto-refresh every 5 minutes

## What is BIP-110?

BIP-110 is a Bitcoin soft fork proposal. Activation requires 55% of blocks in a difficulty period (2016 blocks, ~2 weeks) to signal support via version bit 4.

## Tutorial

1. Install the app "Scriptable" -> [Apple Appstore - Scriptable](https://apps.apple.com/ch/app/scriptable/id1405459188?l=en)
2. Open the app and click the "+" sign on the top right corner
3. Paste the following script:

```js
// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: orange; icon-glyph: signal;
// BIP-110 Signaling Widget v2.1 - Clean version

const scriptStart = new Date();

// API configuration
const API_KEY = "sfkfhoiwrhsh23lsgj";
const API_BASE = "https://thebitcoinportal.com/api";

// Cache for offline support
const fm = FileManager.local();
const cacheFile = fm.joinPath(fm.cacheDirectory(), "bip110-cache.json");

function loadCache() {
  try {
    if (fm.fileExists(cacheFile)) {
      return JSON.parse(fm.readString(cacheFile));
    }
  } catch(e) {}
  return null;
}

function saveCache(data) {
  try {
    fm.writeString(cacheFile, JSON.stringify(data));
  } catch(e) {}
}

// Data
let signalingPct = "N/A";
let blocksInPeriod = 0;
let periodTotal = 2016;
let prevPeriodPct = null;
let nodesPct = "N/A";
let nodesReady = 0;
let fromCache = false;

try {
  let req = new Request(`${API_BASE}/bip110/status`);
  req.headers = {"X-API-Key": API_KEY};
  let json = await req.loadJSON();
  
  if (json.status === "success" && json.data.current_period) {
    let period = json.data.current_period;
    signalingPct = period.signaling_percentage.toFixed(1);
    blocksInPeriod = period.blocks_in_period;
    if (json.data.previous_period) {
      prevPeriodPct = json.data.previous_period.signaling_percentage.toFixed(1);
    }
  }
  
  let req2 = new Request(`${API_BASE}/nodes/bip110/status`);
  req2.headers = {"X-API-Key": API_KEY};
  let json2 = await req2.loadJSON();
  
  if (json2.status === "success" && json2.data) {
    nodesPct = json2.data.bip110_percentage.toFixed(1);
    nodesReady = json2.data.bip110_nodes;
  }
  
  saveCache({ signalingPct, blocksInPeriod, prevPeriodPct, nodesPct, nodesReady });
  
} catch(e) {
  let cached = loadCache();
  if (cached) {
    signalingPct = cached.signalingPct;
    blocksInPeriod = cached.blocksInPeriod;
    prevPeriodPct = cached.prevPeriodPct;
    nodesPct = cached.nodesPct;
    nodesReady = cached.nodesReady;
    fromCache = true;
  }
}

// Color based on percentage
function getSignalingColor(pct) {
  if (pct >= 55) return new Color("#4CAF50");
  if (pct >= 40) return new Color("#8BC34A");
  if (pct >= 20) return new Color("#FFC107");
  if (pct >= 10) return new Color("#FF9800");
  return new Color("#FF5722");
}

// Trend arrow - only if there's actual difference
const currentPct = parseFloat(signalingPct) || 0;
const prevPct = parseFloat(prevPeriodPct) || 0;
let trendArrow = "";
let trendColor = new Color("#888888");
if (prevPeriodPct !== null && Math.abs(currentPct - prevPct) > 0.1) {
  if (currentPct > prevPct) {
    trendArrow = " ↑";
    trendColor = new Color("#4CAF50");
  } else {
    trendArrow = " ↓";
    trendColor = new Color("#FF5722");
  }
}

let widget = await createWidget();
widget.url = "https://thebitcoinportal.com/nodes/bip110";

if (config.runsInWidget) {
  Script.setWidget(widget);
} else {
  widget.presentMedium();
}

Script.complete();

async function createWidget() {
  let w = new ListWidget();
  w.refreshAfterDate = new Date(Date.now() + 1000 * 60 * 5);
  w.backgroundColor = new Color("#000000");
  
  function addCenteredText(parent, text, font, color) {
    let row = parent.addStack();
    row.layoutHorizontally();
    row.addSpacer();
    let label = row.addText(text);
    label.font = font;
    label.textColor = color;
    row.addSpacer();
    return label;
  }
  
  // Title
  let title = w.addText("BIP-110 Signaling");
  title.centerAlignText();
  title.font = Font.boldSystemFont(16);
  title.textColor = new Color("#F7931A");
  
  w.addSpacer(8);
  
  // Main content
  let mainStack = w.addStack();
  mainStack.layoutHorizontally();
  mainStack.centerAlignContent();
  
  // Left column - Miners
  let leftCol = mainStack.addStack();
  leftCol.layoutVertically();
  leftCol.size = new Size(150, 0);
  
  addCenteredText(leftCol, "Miners", Font.mediumSystemFont(12), new Color("#888888"));
  
  // Percentage with optional trend arrow
  let minerRow = leftCol.addStack();
  minerRow.layoutHorizontally();
  minerRow.addSpacer();
  
  let minerPct = minerRow.addText(signalingPct + "%");
  minerPct.font = Font.boldSystemFont(32);
  minerPct.textColor = getSignalingColor(currentPct);
  
  if (trendArrow) {
    let arrow = minerRow.addText(trendArrow);
    arrow.font = Font.boldSystemFont(20);
    arrow.textColor = trendColor;
  }
  
  minerRow.addSpacer();
  
  // Progress bar
  let progressRow = leftCol.addStack();
  progressRow.layoutHorizontally();
  progressRow.addSpacer();
  
  let progressStack = progressRow.addStack();
  progressStack.layoutHorizontally();
  progressStack.spacing = 2;
  
  let progressPct = Math.min(blocksInPeriod / periodTotal, 1);
  let filledBars = Math.round(progressPct * 10);
  
  for (let i = 0; i < 10; i++) {
    let bar = progressStack.addText(i < filledBars ? "▓" : "░");
    bar.font = Font.systemFont(8);
    bar.textColor = i < filledBars ? new Color("#F7931A") : new Color("#333333");
  }
  
  progressRow.addSpacer();
  
  addCenteredText(leftCol, `${blocksInPeriod}/${periodTotal} blocks`, Font.systemFont(10), new Color("#666666"));
  
  mainStack.addSpacer();
  
  // Right column - Nodes
  let rightCol = mainStack.addStack();
  rightCol.layoutVertically();
  rightCol.size = new Size(150, 0);
  
  addCenteredText(rightCol, "Nodes", Font.mediumSystemFont(12), new Color("#888888"));
  addCenteredText(rightCol, nodesPct + "%", Font.boldSystemFont(32), new Color("#FFFFFF"));
  addCenteredText(rightCol, `${nodesReady.toLocaleString()} ready`, Font.systemFont(11), new Color("#F7931A"));
  
  w.addSpacer(6);
  
  // Footer - Updated with actual time
  let timeFormatter = new DateFormatter();
  timeFormatter.useShortTimeStyle();
  let timeString = timeFormatter.string(scriptStart);
  
  let footerText = "Updated: " + timeString;
  if (fromCache) footerText += " (offline)";
  
  let footer = w.addText(footerText);
  footer.centerAlignText();
  footer.font = Font.systemFont(9);
  footer.textColor = fromCache ? new Color("#FF5722") : new Color("#555555");
  
  return w;
}
```

4. Click on the bottom left corner the "sliders" to name your script. For example: BIP-110
5. Click close and done
6. Go to the homescreen, press and hold for a few seconds to make the icons move. Tap on the top left corner the "+" symbol

<img src="./images/2.PNG" style="zoom: 50%;" />

7. Scroll down until you find the "Scriptable" App. Select it and choose the **medium** widget size.

<img src="./images/3.PNG" style="zoom: 30%;" />

8. Click "Add Widget" and tap the new created widget to edit it. Select the created script and you're done!

<img src="./images/5.PNG" style="zoom: 30%;" />

## Data Source

Data is fetched from [The Bitcoin Portal](https://thebitcoinportal.com/nodes/bip110).

## Understanding the Display

- **Miners %** - Percentage of blocks in the current period signaling BIP-110 support (color-coded: red <10%, orange <20%, yellow <40%, green ≥40%)
- **Trend arrow** - Shows ↑ or ↓ if signaling changed vs previous period
- **Progress bar** - How far into the current 2016-block difficulty period
- **Nodes %** - Percentage of network nodes running BIP-110 compatible software
- **Nodes ready** - Absolute count of BIP-110 ready nodes

Activation requires 55% miner signaling within a single difficulty period.

## Offline Support

Widget caches last fetched data. If network is unavailable, shows cached data with "(offline)" indicator.
